from fastapi import FastAPI, HTTPException, Request
from fastapi.middleware.cors import CORSMiddleware
from fastapi.responses import JSONResponse, HTMLResponse
from fastapi.staticfiles import StaticFiles
from pydantic import BaseModel
import json
import pythainlp
import logging
from typing import List, Optional
import re
from datetime import datetime

# ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ logging
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

app = FastAPI(
    title="Thai AI Lawyer",
    description="‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢‡πÑ‡∏ó‡∏¢‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞",
    version="1.0.0"
)

# ‡πÄ‡∏û‡∏¥‡πà‡∏° CORS middleware
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢
try:
    with open("law_data.json", "r", encoding="utf-8") as f:
        LAW_DATA = json.load(f)
    logger.info(f"‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: {len(LAW_DATA)} ‡∏Ç‡πâ‡∏≠")
except Exception as e:
    logger.error(f"‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢‡πÑ‡∏î‡πâ: {e}")
    LAW_DATA = []

class Question(BaseModel):
    question: str
    category: Optional[str] = None

class LawResponse(BaseModel):
    answer: str
    related_laws: List[dict]
    confidence: float
    disclaimer: str
    timestamp: str

@app.get("/", response_class=HTMLResponse)
async def root():
    """‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å‡∏Ç‡∏≠‡∏á‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏ã‡∏ï‡πå"""
    try:
        with open("index.html", "r", encoding="utf-8") as f:
            return HTMLResponse(content=f.read())
    except FileNotFoundError:
        return HTMLResponse(content="""
        <html>
        <head><title>Thai AI Lawyer</title></head>
        <body>
            <h1>Thai AI Lawyer API</h1>
            <p>‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏™‡∏π‡πà Thai AI Lawyer API</p>
            <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏•‡πå index.html ‡πÉ‡∏ô‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå</p>
        </body>
        </html>
        """)

@app.post("/ask", response_model=LawResponse)
async def ask_law(question: Question):
    """‡∏ñ‡∏≤‡∏°‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢"""
    try:
        q = question.question.strip()
        if not q:
            raise HTTPException(status_code=400, detail="‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°")
        
        logger.info(f"‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°: {q}")
        
        # ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á
        results = search_laws(q, question.category)
        
        if results:
            # ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö
            answer = create_answer(results, q)
            confidence = calculate_confidence(results, q)
        else:
            answer = "‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢ ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ô‡∏µ‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏≠‡∏∑‡πà‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡∏ó‡∏ô‡∏≤‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°"
            confidence = 0.0
            results = []
        
        disclaimer = "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏Ñ‡∏≥‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡∏ó‡∏≤‡∏á‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á"
        
        return LawResponse(
            answer=answer,
            related_laws=results,
            confidence=confidence,
            disclaimer=disclaimer,
            timestamp=datetime.now().isoformat()
        )
        
    except Exception as e:
        logger.error(f"‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: {e}")
        raise HTTPException(status_code=500, detail="‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö")

@app.get("/laws")
async def get_all_laws():
    """‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î"""
    return {
        "total": len(LAW_DATA),
        "laws": LAW_DATA
    }

@app.get("/search")
async def search_laws_endpoint(q: str, category: Optional[str] = None):
    """‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢"""
    try:
        results = search_laws(q, category)
        return {
            "query": q,
            "results": results,
            "total": len(results)
        }
    except Exception as e:
        logger.error(f"‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤: {e}")
        raise HTTPException(status_code=500, detail="‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤")

@app.get("/categories")
async def get_categories():
    """‡∏î‡∏π‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢"""
    categories = set()
    for law in LAW_DATA:
        if "category" in law:
            categories.add(law["category"])
    
    return {
        "categories": list(categories),
        "total": len(categories)
    }

def search_laws(query: str, category: Optional[str] = None) -> List[dict]:
    """‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á - ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÉ‡∏´‡πâ‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥‡πÅ‡∏•‡∏∞‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏•‡∏∏‡∏°‡∏°‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô"""
    query_words = pythainlp.word_tokenize(query, keep_whitespace=False)
    results = []
    
    # ‡∏Ñ‡∏≥‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡∏û‡πâ‡∏≠‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏°‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏•‡∏∏‡∏°
    keyword_mappings = {
        # ‡∏≠‡∏≤‡∏ç‡∏≤ - ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡πÅ‡∏•‡∏∞‡∏£‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏¢
        '‡∏Ü‡πà‡∏≤': ['‡∏Ü‡πà‡∏≤', '‡∏Ü‡∏≤‡∏ï‡∏Å‡∏£‡∏£‡∏°', '‡∏õ‡∏£‡∏∞‡∏´‡∏≤‡∏£', '‡∏Ü‡πà‡∏≤‡∏Ñ‡∏ô‡∏ï‡∏≤‡∏¢', '‡∏Ü‡∏≤‡∏ï‡∏Å‡∏£', '‡∏Ü‡∏≤‡∏ï‡∏£'],
        '‡∏ó‡∏≥‡∏£‡πâ‡∏≤‡∏¢‡∏£‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏¢': ['‡∏ó‡∏≥‡∏£‡πâ‡∏≤‡∏¢', '‡∏£‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏¢', '‡∏ï‡∏ö', '‡∏ï‡∏µ', '‡∏ó‡∏∏‡∏ö', '‡πÄ‡∏ï‡∏∞', '‡∏ï‡πà‡∏≠‡∏¢', '‡∏ä‡∏Å', '‡∏ó‡∏≥‡∏£‡πâ‡∏≤‡∏¢‡∏£‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏¢', '‡∏ö‡∏≤‡∏î‡πÄ‡∏à‡πá‡∏ö'],
        '‡∏ä‡∏≥‡πÄ‡∏£‡∏≤': ['‡∏ä‡∏≥‡πÄ‡∏£‡∏≤', '‡∏Ç‡πà‡∏°‡∏Ç‡∏∑‡∏ô', '‡∏≠‡∏ô‡∏≤‡∏à‡∏≤‡∏£', '‡∏Ç‡πà‡∏°‡∏Ç‡∏∑‡∏ô‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ä‡∏≥‡πÄ‡∏£‡∏≤', '‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ä‡∏≥‡πÄ‡∏£‡∏≤', '‡∏Ç‡πà‡∏°‡∏Ç‡∏∑‡∏ô‡πÉ‡∏à'],
        '‡∏û‡∏£‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡πÄ‡∏¢‡∏≤‡∏ß‡πå': ['‡∏û‡∏£‡∏≤‡∏Å', '‡∏ú‡∏π‡πâ‡πÄ‡∏¢‡∏≤‡∏ß‡πå', '‡πÄ‡∏¢‡∏≤‡∏ß‡πå', '‡πÄ‡∏î‡πá‡∏Å', '‡∏û‡∏£‡∏≤‡∏Å‡πÄ‡∏î‡πá‡∏Å', '‡∏•‡∏±‡∏Å‡∏û‡∏≤', '‡∏û‡∏≤‡πÑ‡∏õ'],
        
        # ‡∏≠‡∏≤‡∏ç‡∏≤ - ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå
        '‡∏•‡∏±‡∏Å‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå': ['‡∏•‡∏±‡∏Å', '‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå', '‡∏Ç‡πÇ‡∏°‡∏¢', '‡∏•‡∏±‡∏Å‡∏Ç‡πÇ‡∏°‡∏¢', '‡∏•‡∏±‡∏Å‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå', '‡∏Ç‡πÇ‡∏°‡∏¢‡∏Ç‡∏≠‡∏á', '‡∏•‡∏±‡∏Å‡∏Ç‡∏≠‡∏á'],
        '‡∏â‡πâ‡∏≠‡πÇ‡∏Å‡∏á': ['‡∏â‡πâ‡∏≠', '‡πÇ‡∏Å‡∏á', '‡∏´‡∏•‡∏≠‡∏Å', '‡∏â‡πâ‡∏≠‡πÇ‡∏Å‡∏á', '‡∏´‡∏•‡∏≠‡∏Å‡∏•‡∏ß‡∏á', '‡πÇ‡∏Å‡∏á‡∏Å‡∏¥‡∏ô', '‡∏ó‡∏∏‡∏à‡∏£‡∏¥‡∏ï'],
        '‡∏õ‡∏•‡πâ‡∏ô': ['‡∏õ‡∏•‡πâ‡∏ô', '‡∏ä‡∏¥‡∏á', '‡πÇ‡∏à‡∏£', '‡∏õ‡∏•‡πâ‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå', '‡∏ä‡∏¥‡∏á‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå', '‡πÇ‡∏à‡∏£‡∏Å‡∏£‡∏£‡∏°'],
        '‡∏¢‡∏±‡∏Å‡∏¢‡∏≠‡∏Å': ['‡∏¢‡∏±‡∏Å‡∏¢‡∏≠‡∏Å', '‡∏¢‡∏±‡∏Å‡∏¢‡∏≠‡∏Å‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå', '‡∏¢‡∏±‡∏Å‡∏¢‡∏≠‡∏Å‡πÄ‡∏á‡∏¥‡∏ô', '‡∏¢‡∏±‡∏Å‡∏¢‡∏≠‡∏Å‡∏Ç‡∏≠‡∏á'],
        
        # ‡∏≠‡∏≤‡∏ç‡∏≤ - ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏á‡∏ö‡∏™‡∏∏‡∏Ç
        '‡∏¢‡∏≤‡πÄ‡∏™‡∏û‡∏ï‡∏¥‡∏î': ['‡∏¢‡∏≤‡πÄ‡∏™‡∏û‡∏ï‡∏¥‡∏î', '‡∏¢‡∏≤', '‡πÄ‡∏™‡∏û', '‡∏ï‡∏¥‡∏î', '‡πÄ‡∏Æ‡πÇ‡∏£‡∏≠‡∏µ‡∏ô', '‡∏°‡∏≠‡∏£‡πå‡∏ü‡∏µ‡∏ô', '‡πÇ‡∏Ñ‡πÄ‡∏Ñ‡∏ô', '‡∏Å‡∏±‡∏ç‡∏ä‡∏≤', '‡∏¢‡∏≤‡∏ö‡πâ‡∏≤', '‡πÑ‡∏≠‡∏ã‡πå', '‡πÅ‡∏≠‡∏°‡πÄ‡∏ü‡∏ï‡∏≤‡∏°‡∏µ‡∏ô'],
        '‡∏Ñ‡∏≠‡∏£‡πå‡∏£‡∏±‡∏õ‡∏ä‡∏±‡∏ô': ['‡∏Ñ‡∏≠‡∏£‡πå‡∏£‡∏±‡∏õ‡∏ä‡∏±‡∏ô', '‡∏ó‡∏∏‡∏à‡∏£‡∏¥‡∏ï', '‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏ö‡∏ô', '‡∏™‡∏¥‡∏ô‡∏ö‡∏ô', '‡∏Ñ‡∏≠‡∏£‡πå‡∏£‡∏±‡∏õ‡∏ä‡∏±‡πà‡∏ô', '‡∏ó‡∏∏‡∏à‡∏£‡∏¥‡∏ï‡∏Ñ‡∏≠‡∏£‡πå‡∏£‡∏±‡∏õ‡∏ä‡∏±‡∏ô'],
        
        # ‡∏≠‡∏≤‡∏ç‡∏≤ - ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏¥‡∏î‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå
        '‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå': ['‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå', '‡∏£‡∏∞‡∏ö‡∏ö', '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', '‡πÅ‡∏Æ‡∏Å', '‡πÑ‡∏ß‡∏£‡∏±‡∏™', '‡∏™‡πÅ‡∏õ‡∏°', '‡∏•‡∏≤‡∏°‡∏Å', '‡πÄ‡∏ó‡πá‡∏à', '‡πÑ‡∏ã‡πÄ‡∏ö‡∏≠‡∏£‡πå', '‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï'],
        '‡πÅ‡∏Æ‡∏Å': ['‡πÅ‡∏Æ‡∏Å', '‡πÅ‡∏Æ‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå', '‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á', '‡πÄ‡∏à‡∏≤‡∏∞‡∏£‡∏∞‡∏ö‡∏ö', '‡πÄ‡∏à‡∏≤‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'],
        '‡πÑ‡∏ß‡∏£‡∏±‡∏™': ['‡πÑ‡∏ß‡∏£‡∏±‡∏™', '‡∏°‡∏±‡∏•‡πÅ‡∏ß‡∏£‡πå', '‡∏™‡∏õ‡∏≤‡∏¢‡πÅ‡∏ß‡∏£‡πå', '‡∏ó‡∏£‡∏≠‡∏¢‡∏à‡∏±‡∏ô', '‡πÅ‡∏£‡∏ô‡∏ã‡∏±‡∏°‡πÅ‡∏ß‡∏£‡πå'],
        
        # ‡πÅ‡∏û‡πà‡∏á - ‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡πÅ‡∏•‡∏∞‡∏´‡∏ô‡∏µ‡πâ
        '‡∏™‡∏±‡∏ç‡∏ç‡∏≤': ['‡∏™‡∏±‡∏ç‡∏ç‡∏≤', '‡∏Ç‡πâ‡∏≠‡∏ï‡∏Å‡∏•‡∏á', '‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≤‡∏¢', '‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡πÄ‡∏ä‡πà‡∏≤', '‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏à‡πâ‡∏≤‡∏á'],
        '‡∏´‡∏ô‡∏µ‡πâ': ['‡∏´‡∏ô‡∏µ‡πâ', '‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏π‡πâ', '‡πÄ‡∏á‡∏¥‡∏ô‡∏¢‡∏∑‡∏°', '‡∏ä‡∏≥‡∏£‡∏∞‡∏´‡∏ô‡∏µ‡πâ', '‡∏ú‡∏¥‡∏î‡∏ô‡∏±‡∏î', '‡∏ú‡∏¥‡∏î‡∏™‡∏±‡∏ç‡∏ç‡∏≤'],
        '‡∏•‡∏∞‡πÄ‡∏°‡∏¥‡∏î': ['‡∏•‡∏∞‡πÄ‡∏°‡∏¥‡∏î', '‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢', '‡∏Ñ‡πà‡∏≤‡∏™‡∏¥‡∏ô‡πÑ‡∏´‡∏°', '‡∏ä‡∏î‡πÉ‡∏ä‡πâ', '‡∏ä‡∏î‡πÄ‡∏ä‡∏¢'],
        
        # ‡πÅ‡∏û‡πà‡∏á - ‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß
        '‡∏™‡∏°‡∏£‡∏™': ['‡∏™‡∏°‡∏£‡∏™', '‡πÅ‡∏ï‡πà‡∏á‡∏á‡∏≤‡∏ô', '‡∏à‡∏î‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏°‡∏£‡∏™', '‡∏Ñ‡∏π‡πà‡∏™‡∏°‡∏£‡∏™'],
        '‡∏´‡∏¢‡πà‡∏≤': ['‡∏´‡∏¢‡πà‡∏≤', '‡∏´‡∏¢‡πà‡∏≤‡∏£‡πâ‡∏≤‡∏á', '‡πÄ‡∏•‡∏¥‡∏Å‡∏™‡∏°‡∏£‡∏™', '‡πÅ‡∏¢‡∏Å‡∏ó‡∏≤‡∏á'],
        '‡∏°‡∏£‡∏î‡∏Å': ['‡∏°‡∏£‡∏î‡∏Å', '‡∏û‡∏¥‡∏ô‡∏±‡∏¢‡∏Å‡∏£‡∏£‡∏°', '‡∏ó‡∏≤‡∏¢‡∏≤‡∏ó', '‡πÅ‡∏ö‡πà‡∏á‡∏°‡∏£‡∏î‡∏Å', '‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏°‡∏£‡∏î‡∏Å'],
        
        # ‡πÅ‡∏û‡πà‡∏á - ‡∏ó‡∏µ‡πà‡∏î‡∏¥‡∏ô‡πÅ‡∏•‡∏∞‡∏≠‡∏™‡∏±‡∏á‡∏´‡∏≤‡∏£‡∏¥‡∏°‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå
        '‡∏ó‡∏µ‡πà‡∏î‡∏¥‡∏ô': ['‡∏ó‡∏µ‡πà‡∏î‡∏¥‡∏ô', '‡πÇ‡∏â‡∏ô‡∏î', '‡∏Å‡∏£‡∏£‡∏°‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå', '‡∏†‡∏≤‡∏£‡∏∞‡∏à‡∏≥‡∏¢‡∏≠‡∏°', '‡∏à‡∏≥‡∏ô‡∏≠‡∏á', '‡∏Ç‡∏≤‡∏¢‡∏ù‡∏≤‡∏Å'],
        
        # ‡∏†‡∏≤‡∏©‡∏µ
        '‡∏†‡∏≤‡∏©‡∏µ': ['‡∏†‡∏≤‡∏©‡∏µ', 'vat', '‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°', '‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏î‡πâ', '‡∏¢‡∏∑‡πà‡∏ô‡πÅ‡∏ö‡∏ö', '‡πÄ‡∏™‡∏µ‡∏¢‡∏†‡∏≤‡∏©‡∏µ', '‡∏™‡∏£‡∏£‡∏û‡∏≤‡∏Å‡∏£'],
        
        # ‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡∏õ‡∏±‡∏ç‡∏ç‡∏≤
        '‡∏•‡∏¥‡∏Ç‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå': ['‡∏•‡∏¥‡∏Ç‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå', '‡∏•‡∏¥‡∏Ç‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå', '‡∏•‡∏∞‡πÄ‡∏°‡∏¥‡∏î‡∏•‡∏¥‡∏Ç‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå'],
        '‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏ö‡∏±‡∏ï‡∏£': ['‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏ö‡∏±‡∏ï‡∏£', '‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏ö‡∏±‡∏ï‡∏£', '‡∏•‡∏∞‡πÄ‡∏°‡∏¥‡∏î‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏ö‡∏±‡∏ï‡∏£'],
        '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤': ['‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤', '‡πÅ‡∏ö‡∏£‡∏ô‡∏î‡πå', '‡πÇ‡∏•‡πÇ‡∏Å‡πâ', '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤'],
        
        # ‡πÅ‡∏£‡∏á‡∏á‡∏≤‡∏ô
        '‡πÅ‡∏£‡∏á‡∏á‡∏≤‡∏ô': ['‡πÅ‡∏£‡∏á‡∏á‡∏≤‡∏ô', '‡∏•‡∏π‡∏Å‡∏à‡πâ‡∏≤‡∏á', '‡∏ô‡∏≤‡∏¢‡∏à‡πâ‡∏≤‡∏á', '‡πÑ‡∏•‡πà‡∏≠‡∏≠‡∏Å', '‡πÄ‡∏•‡∏¥‡∏Å‡∏à‡πâ‡∏≤‡∏á', '‡∏Ñ‡πà‡∏≤‡∏ä‡∏î‡πÄ‡∏ä‡∏¢'],
        
        # ‡∏£‡∏±‡∏ê‡∏ò‡∏£‡∏£‡∏°‡∏ô‡∏π‡∏ç
        '‡∏£‡∏±‡∏ê‡∏ò‡∏£‡∏£‡∏°‡∏ô‡∏π‡∏ç': ['‡∏£‡∏±‡∏ê‡∏ò‡∏£‡∏£‡∏°‡∏ô‡∏π‡∏ç', '‡∏™‡∏¥‡∏ó‡∏ò‡∏¥', '‡πÄ‡∏™‡∏£‡∏µ‡∏†‡∏≤‡∏û', '‡∏£‡∏±‡∏ê‡∏™‡∏†‡∏≤', '‡∏£‡∏±‡∏ê‡∏ö‡∏≤‡∏•', '‡∏®‡∏≤‡∏•'],
        '‡∏™‡∏¥‡∏ó‡∏ò‡∏¥': ['‡∏™‡∏¥‡∏ó‡∏ò‡∏¥', '‡πÄ‡∏™‡∏£‡∏µ‡∏†‡∏≤‡∏û', '‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏û‡∏•‡πÄ‡∏°‡∏∑‡∏≠‡∏á', '‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô'],
        
        # ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ
        '‡πÇ‡∏ó‡∏©': ['‡πÇ‡∏ó‡∏©', '‡∏à‡∏≥‡∏Ñ‡∏∏‡∏Å', '‡∏õ‡∏£‡∏±‡∏ö', '‡∏õ‡∏£‡∏∞‡∏´‡∏≤‡∏£', '‡∏Å‡∏±‡∏Å‡∏Ç‡∏±‡∏á', '‡∏Ñ‡∏∏‡∏°‡∏Ç‡∏±‡∏á'],
        '‡∏≠‡∏≤‡∏¢‡∏∏': ['‡∏≠‡∏≤‡∏¢‡∏∏', '‡∏õ‡∏µ', '‡∏Ç‡∏ß‡∏ö', '‡∏ú‡∏π‡πâ‡πÄ‡∏¢‡∏≤‡∏ß‡πå', '‡∏ú‡∏π‡πâ‡πÉ‡∏´‡∏ç‡πà', '‡πÄ‡∏î‡πá‡∏Å'],
        '‡πÄ‡∏á‡∏¥‡∏ô': ['‡πÄ‡∏á‡∏¥‡∏ô', '‡∏ö‡∏≤‡∏ó', '‡∏Ñ‡πà‡∏≤‡∏õ‡∏£‡∏±‡∏ö', '‡∏Ñ‡πà‡∏≤‡∏ä‡∏î‡πÄ‡∏ä‡∏¢', '‡∏Ñ‡πà‡∏≤‡∏™‡∏¥‡∏ô‡πÑ‡∏´‡∏°', '‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏π‡πâ', '‡πÄ‡∏á‡∏¥‡∏ô‡∏¢‡∏∑‡∏°']
    }
    
    # ‡∏Ñ‡∏≥‡∏´‡∏¢‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
    stop_words = {'‡∏Ñ‡∏∑‡∏≠', '‡∏ó‡∏µ‡πà', '‡πÉ‡∏ô', '‡∏Ç‡∏≠‡∏á', '‡∏Å‡∏±‡∏ö', '‡πÅ‡∏•‡∏∞', '‡∏´‡∏£‡∏∑‡∏≠', '‡πÅ‡∏ï‡πà', '‡πÅ‡∏•‡πâ‡∏ß', '‡∏à‡∏∞', '‡πÑ‡∏î‡πâ', '‡πÉ‡∏´‡πâ', '‡∏°‡∏µ', '‡πÄ‡∏õ‡πá‡∏ô', '‡∏≠‡∏¢‡∏π‡πà', '‡πÑ‡∏õ', '‡∏°‡∏≤', '‡∏ó‡∏≥', '‡πÉ‡∏´‡πâ', '‡πÑ‡∏î‡πâ', '‡∏ï‡πâ‡∏≠‡∏á', '‡∏Ñ‡∏ß‡∏£', '‡∏à‡∏∞', '‡∏≠‡∏≤‡∏à', '‡∏Ñ‡∏á', '‡∏ô‡πà‡∏≤‡∏à‡∏∞', '‡∏Ñ‡∏á‡∏à‡∏∞', '‡∏≠‡∏≤‡∏à‡∏à‡∏∞'}
    
    for law in LAW_DATA:
        # ‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà
        if category and law.get("category") != category:
            continue
            
        # ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á
        score = 0
        law_text = f"{law.get('title', '')} {law.get('text', '')}".lower()
        query_lower = query.lower()
        
        # 1. ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ï‡∏≤‡∏°‡πÄ‡∏•‡∏Ç‡∏°‡∏≤‡∏ï‡∏£‡∏≤ (‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î)
        section_match = re.search(r'‡∏°‡∏≤‡∏ï‡∏£‡∏≤\s*(\d+)', query_lower)
        if section_match:
            section_number = section_match.group(1)
            if section_number in law.get('code', '') or section_number in law.get('title', ''):
                score += 1000  # ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ï‡∏≤‡∏°‡πÄ‡∏•‡∏Ç‡∏°‡∏≤‡∏ï‡∏£‡∏≤
        
        # 2. ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≥‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡∏û‡πâ‡∏≠‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏°‡∏≤‡∏¢
        for keyword_group, synonyms in keyword_mappings.items():
            if any(synonym in query_lower for synonym in synonyms):
                if any(synonym in law_text for synonym in synonyms):
                    score += 50  # ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏π‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç
                    
                    # ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏≥‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏≤‡∏ï‡∏£‡∏≤
                    if any(synonym in law.get('title', '').lower() for synonym in synonyms):
                        score += 30
        
        # 3. ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≥‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ (‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô‡∏Ñ‡∏≥‡∏´‡∏¢‡∏∏‡∏î)
        for word in query_words:
            word_lower = word.lower()
            if word_lower not in stop_words and len(word_lower) > 1:
                if word_lower in law_text:
                    score += 2
                    
                    # ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏≥‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏≤‡∏ï‡∏£‡∏≤
                    if word_lower in law.get('title', '').lower():
                        score += 5
        
        # 4. ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ï‡∏≤‡∏°‡∏ß‡∏•‡∏µ‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á
        # ‡πÅ‡∏ö‡πà‡∏á‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏•‡∏µ 2-3 ‡∏Ñ‡∏≥
        query_phrases = []
        for i in range(len(query_words) - 1):
            phrase = ' '.join(query_words[i:i+2])
            if len(phrase) > 3:
                query_phrases.append(phrase)
        
        for phrase in query_phrases:
            if phrase.lower() in law_text:
                score += 10
        
        # 5. ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ï‡∏≤‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á
        law_category = law.get('category', '').lower()
        if '‡∏≠‡∏≤‡∏ç‡∏≤' in law_category and any(word in query_lower for word in ['‡∏ú‡∏¥‡∏î', '‡πÇ‡∏ó‡∏©', '‡∏≠‡∏≤‡∏ç‡∏≤', '‡∏à‡∏≥‡∏Ñ‡∏∏‡∏Å', '‡∏õ‡∏£‡∏±‡∏ö', '‡∏õ‡∏£‡∏∞‡∏´‡∏≤‡∏£']):
            score += 15
        elif '‡πÅ‡∏û‡πà‡∏á' in law_category and any(word in query_lower for word in ['‡∏™‡∏±‡∏ç‡∏ç‡∏≤', '‡∏´‡∏ô‡∏µ‡πâ', '‡∏•‡∏∞‡πÄ‡∏°‡∏¥‡∏î', '‡∏°‡∏£‡∏î‡∏Å', '‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß']):
            score += 15
        elif '‡∏£‡∏±‡∏ê‡∏ò‡∏£‡∏£‡∏°‡∏ô‡∏π‡∏ç' in law_category and any(word in query_lower for word in ['‡∏™‡∏¥‡∏ó‡∏ò‡∏¥', '‡πÄ‡∏™‡∏£‡∏µ‡∏†‡∏≤‡∏û', '‡∏£‡∏±‡∏ê‡∏™‡∏†‡∏≤', '‡∏£‡∏±‡∏ê‡∏ö‡∏≤‡∏•']):
            score += 15
        
        # 6. ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ï‡∏≤‡∏°‡∏ö‡∏£‡∏¥‡∏ö‡∏ó‡∏û‡∏¥‡πÄ‡∏®‡∏©
        # ‡∏Å‡∏£‡∏ì‡∏µ‡∏ä‡∏≥‡πÄ‡∏£‡∏≤‡∏ú‡∏π‡πâ‡πÄ‡∏¢‡∏≤‡∏ß‡πå
        if any(word in query_lower for word in ['‡∏ó‡πâ‡∏≠‡∏á', '‡∏ó‡∏≥‡∏ó‡πâ‡∏≠‡∏á', '‡∏ä‡∏≥‡πÄ‡∏£‡∏≤', '‡∏Ç‡πà‡∏°‡∏Ç‡∏∑‡∏ô', '‡πÄ‡∏î‡πá‡∏Å', '‡∏ú‡∏π‡πâ‡πÄ‡∏¢‡∏≤‡∏ß‡πå']):
            if '277' in law.get('title', '') or '277' in law.get('code', ''):
                score += 200
            elif '‡∏ä‡∏≥‡πÄ‡∏£‡∏≤' in law_text:
                score += 150
            elif '‡∏ú‡∏π‡πâ‡πÄ‡∏¢‡∏≤‡∏ß‡πå' in law_text:
                score += 100
        
        # ‡∏Å‡∏£‡∏ì‡∏µ‡∏•‡∏±‡∏Å‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå
        if any(word in query_lower for word in ['‡∏•‡∏±‡∏Å', '‡∏Ç‡πÇ‡∏°‡∏¢', '‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå']):
            if '‡∏•‡∏±‡∏Å‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå' in law_text or '‡∏Ç‡πÇ‡∏°‡∏¢' in law_text:
                score += 100
        
        # ‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏≥‡∏£‡πâ‡∏≤‡∏¢‡∏£‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏¢
        if any(word in query_lower for word in ['‡∏ó‡∏≥‡∏£‡πâ‡∏≤‡∏¢', '‡∏ï‡∏ö', '‡∏ï‡∏µ', '‡∏ï‡πà‡∏≠‡∏¢']):
            if '‡∏ó‡∏≥‡∏£‡πâ‡∏≤‡∏¢' in law_text:
                score += 100
        
        # ‡∏Å‡∏£‡∏ì‡∏µ‡∏Ü‡πà‡∏≤
        if any(word in query_lower for word in ['‡∏Ü‡πà‡∏≤', '‡∏Ü‡∏≤‡∏ï‡∏Å‡∏£‡∏£‡∏°']):
            if '‡∏Ü‡πà‡∏≤' in law_text:
                score += 100
        
        # 7. ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ï‡∏≤‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏≥
        for word in query_words:
            word_lower = word.lower()
            if word_lower not in stop_words and len(word_lower) > 1:
                word_count = law_text.count(word_lower)
                if word_count > 0:
                    score += min(word_count, 10)  # ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà 10
        
        # 8. ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ï‡∏≤‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô
        for word in query_words:
            word_lower = word.lower()
            if word_lower not in stop_words and len(word_lower) > 2:
                if word_lower in law_text:
                    score += len(word_lower)  # ‡∏¢‡∏¥‡πà‡∏á‡∏Ñ‡∏≥‡∏¢‡∏≤‡∏ß‡∏¢‡∏¥‡πà‡∏á‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏π‡∏á
        
        if score > 0:
            results.append({
                **law,
                "relevance_score": score
            })
    
    # ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á
    results.sort(key=lambda x: x["relevance_score"], reverse=True)
    return results[:10]  # ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÄ‡∏õ‡πá‡∏ô 10 ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡πÅ‡∏£‡∏Å

def analyze_case(question: str, main_law: dict) -> tuple[str, str, str]:
    """
    ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡πÄ‡∏ó‡πá‡∏à‡∏à‡∏£‡∏¥‡∏á‡πÅ‡∏•‡∏∞‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏ä‡∏¥‡∏á‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡πÅ‡∏ö‡∏ö rule-based ‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏•‡∏∏‡∏°‡∏ó‡∏∏‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢
    ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÉ‡∏´‡πâ‡∏â‡∏•‡∏≤‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏£‡∏ì‡∏µ '‡∏ó‡∏≥‡∏ú‡∏π‡πâ‡∏´‡∏ç‡∏¥‡∏á‡∏ó‡πâ‡∏≠‡∏á' ‡πÇ‡∏î‡∏¢‡πÅ‡∏¢‡∏Å‡πÅ‡∏¢‡∏∞‡∏≠‡∏≤‡∏¢‡∏∏ ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏° ‡∏Ç‡πà‡∏°‡∏Ç‡∏∑‡∏ô ‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡πÄ‡∏™‡∏°‡∏≠
    """
    q = question.lower()
    verdict = ""
    analysis = []
    advice = []
    related_laws = []

    # ‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏≠‡∏≤‡∏¢‡∏∏‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏°
    is_child = any(word in q for word in ['‡πÄ‡∏î‡πá‡∏Å', '‡∏ú‡∏π‡πâ‡πÄ‡∏¢‡∏≤‡∏ß‡πå', '‡∏≠‡∏≤‡∏¢‡∏∏‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤', '‡∏≠‡∏≤‡∏¢‡∏∏‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô', '‡∏≠‡∏≤‡∏¢‡∏∏‡πÑ‡∏°‡πà‡∏ñ‡∏∂‡∏á', '‡∏≠‡∏≤‡∏¢‡∏∏ 13', '‡∏≠‡∏≤‡∏¢‡∏∏ 14', '‡∏≠‡∏≤‡∏¢‡∏∏ 15', '‡∏™‡∏¥‡∏ö‡∏™‡∏≤‡∏°', '13', '‡∏™‡∏¥‡∏ö‡∏™‡∏µ‡πà', '14', '‡∏™‡∏¥‡∏ö‡∏´‡πâ‡∏≤', '15'])
    is_minor = any(word in q for word in ['‡∏≠‡∏≤‡∏¢‡∏∏ 16', '‡∏≠‡∏≤‡∏¢‡∏∏ 17', '‡∏≠‡∏≤‡∏¢‡∏∏ 18', '‡∏™‡∏¥‡∏ö‡∏´‡∏Å', '16', '‡∏™‡∏¥‡∏ö‡πÄ‡∏à‡πá‡∏î', '17', '‡∏™‡∏¥‡∏ö‡πÅ‡∏õ‡∏î', '18'])
    is_adult = any(word in q for word in ['‡∏≠‡∏≤‡∏¢‡∏∏ 20', '‡∏≠‡∏≤‡∏¢‡∏∏ 19', '‡∏≠‡∏≤‡∏¢‡∏∏ 21', '‡∏ö‡∏£‡∏£‡∏•‡∏∏‡∏ô‡∏¥‡∏ï‡∏¥‡∏†‡∏≤‡∏ß‡∏∞', '‡∏ú‡∏π‡πâ‡πÉ‡∏´‡∏ç‡πà'])
    is_consent = any(word in q for word in ['‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏°', '‡πÄ‡∏ï‡πá‡∏°‡πÉ‡∏à', '‡∏™‡∏°‡∏¢‡∏≠‡∏°'])
    is_rape = any(word in q for word in ['‡∏Ç‡πà‡∏°‡∏Ç‡∏∑‡∏ô', '‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö', '‡∏Ç‡∏π‡πà‡πÄ‡∏Ç‡πá‡∏ç', '‡∏Ç‡πà‡∏°‡∏Ç‡∏π‡πà', '‡∏Ç‡∏∑‡∏ô‡πÉ‡∏à', '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏°'])
    is_pregnant = any(word in q for word in ['‡∏ó‡πâ‡∏≠‡∏á', '‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡∏£‡∏£‡∏†‡πå', '‡∏ó‡∏≥‡∏ó‡πâ‡∏≠‡∏á'])
    is_woman = any(word in q for word in ['‡∏ú‡∏π‡πâ‡∏´‡∏ç‡∏¥‡∏á', '‡∏´‡∏ç‡∏¥‡∏á', '‡πÄ‡∏î‡πá‡∏Å‡∏´‡∏ç‡∏¥‡∏á'])

    # ‡∏Å‡∏£‡∏ì‡∏µ "‡∏ó‡∏≥‡∏ú‡∏π‡πâ‡∏´‡∏ç‡∏¥‡∏á‡∏ó‡πâ‡∏≠‡∏á" ‡∏´‡∏£‡∏∑‡∏≠ "‡∏ó‡∏≥‡∏ó‡πâ‡∏≠‡∏á"
    if is_pregnant and is_woman:
        if is_child:
            verdict = "‚ùå ‡∏ú‡∏¥‡∏î - ‡∏ê‡∏≤‡∏ô‡∏ä‡∏≥‡πÄ‡∏£‡∏≤‡πÄ‡∏î‡πá‡∏Å‡∏≠‡∏≤‡∏¢‡∏∏‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤ 15 ‡∏õ‡∏µ"
            analysis.append("- ‡∏Å‡∏≤‡∏£‡∏°‡∏µ‡πÄ‡∏û‡∏®‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏Å‡∏±‡∏ö‡πÄ‡∏î‡πá‡∏Å‡∏≠‡∏≤‡∏¢‡∏∏‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤ 15 ‡∏õ‡∏µ ‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏°‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢")
            analysis.append("- ‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢‡∏≠‡∏≤‡∏ç‡∏≤ ‡∏°‡∏≤‡∏ï‡∏£‡∏≤ 277")
            advice.append("- ‡πÅ‡∏à‡πâ‡∏á‡∏ú‡∏π‡πâ‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡πÅ‡∏à‡πâ‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏±‡∏ö‡∏ï‡∏≥‡∏£‡∏ß‡∏à")
            advice.append("- ‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏°‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏û‡∏¢‡∏≤‡∏ô")
            related_laws.append("‡∏°‡∏≤‡∏ï‡∏£‡∏≤ 277")
        elif is_minor:
            verdict = "‚ö†Ô∏è ‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡πÄ‡∏ó‡πá‡∏à‡∏à‡∏£‡∏¥‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°"
            analysis.append("- ‡∏Å‡∏≤‡∏£‡∏°‡∏µ‡πÄ‡∏û‡∏®‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏Å‡∏±‡∏ö‡∏ú‡∏π‡πâ‡πÄ‡∏¢‡∏≤‡∏ß‡πå‡∏≠‡∏≤‡∏¢‡∏∏ 15-18 ‡∏õ‡∏µ ‡∏≠‡∏≤‡∏à‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πà‡∏≤‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏¥‡∏î ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏° ‡∏´‡∏£‡∏∑‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏´‡∏•‡∏≠‡∏Å‡∏•‡∏ß‡∏á ‡∏Ç‡πà‡∏°‡∏Ç‡∏π‡πà")
            analysis.append("- ‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°")
            analysis.append("- ‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢‡∏≠‡∏≤‡∏ç‡∏≤ ‡∏°‡∏≤‡∏ï‡∏£‡∏≤ 277, 279, 282")
            advice.append("- ‡∏Ñ‡∏ß‡∏£‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡∏ó‡∏ô‡∏≤‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°")
            related_laws.extend(["‡∏°‡∏≤‡∏ï‡∏£‡∏≤ 277", "‡∏°‡∏≤‡∏ï‡∏£‡∏≤ 279", "‡∏°‡∏≤‡∏ï‡∏£‡∏≤ 282"])
        elif is_rape:
            verdict = "‚ùå ‡∏ú‡∏¥‡∏î - ‡∏ê‡∏≤‡∏ô‡∏Ç‡πà‡∏°‡∏Ç‡∏∑‡∏ô‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ä‡∏≥‡πÄ‡∏£‡∏≤"
            analysis.append("- ‡∏Å‡∏≤‡∏£‡∏°‡∏µ‡πÄ‡∏û‡∏®‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏°‡∏Ç‡∏≠‡∏á‡∏ù‡πà‡∏≤‡∏¢‡∏´‡∏ç‡∏¥‡∏á ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏¥‡∏î‡∏ê‡∏≤‡∏ô‡∏Ç‡πà‡∏°‡∏Ç‡∏∑‡∏ô")
            analysis.append("- ‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢‡∏≠‡∏≤‡∏ç‡∏≤ ‡∏°‡∏≤‡∏ï‡∏£‡∏≤ 276")
            advice.append("- ‡πÅ‡∏à‡πâ‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏±‡∏ö‡∏ï‡∏≥‡∏£‡∏ß‡∏à‡∏ó‡∏±‡∏ô‡∏ó‡∏µ")
            advice.append("- ‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏°‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏û‡∏¢‡∏≤‡∏ô")
            related_laws.append("‡∏°‡∏≤‡∏ï‡∏£‡∏≤ 276")
        elif is_adult and is_consent:
            verdict = "‚úÖ ‡πÑ‡∏°‡πà‡∏ú‡∏¥‡∏î - ‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏°‡πÅ‡∏•‡∏∞‡∏ö‡∏£‡∏£‡∏•‡∏∏‡∏ô‡∏¥‡∏ï‡∏¥‡∏†‡∏≤‡∏ß‡∏∞"
            analysis.append("- ‡∏Å‡∏≤‡∏£‡∏°‡∏µ‡πÄ‡∏û‡∏®‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏Å‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏´‡∏ç‡∏¥‡∏á‡∏ó‡∏µ‡πà‡∏ö‡∏£‡∏£‡∏•‡∏∏‡∏ô‡∏¥‡∏ï‡∏¥‡∏†‡∏≤‡∏ß‡∏∞‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏° ‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏¥‡∏î‡∏≠‡∏≤‡∏ç‡∏≤")
            advice.append("- ‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ó‡∏≤‡∏á‡πÅ‡∏û‡πà‡∏á ‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á‡∏î‡∏π‡∏ö‡∏∏‡∏ï‡∏£ ‡πÉ‡∏´‡πâ‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡∏ó‡∏ô‡∏≤‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°")
        else:
            verdict = "‚ö†Ô∏è ‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡πÄ‡∏ó‡πá‡∏à‡∏à‡∏£‡∏¥‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°"
            analysis.append("- ‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏≠‡∏≤‡∏¢‡∏∏‡∏Ç‡∏≠‡∏á‡∏ù‡πà‡∏≤‡∏¢‡∏´‡∏ç‡∏¥‡∏á‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏°")
            analysis.append("- ‡∏´‡∏≤‡∏Å‡∏ù‡πà‡∏≤‡∏¢‡∏´‡∏ç‡∏¥‡∏á‡∏≠‡∏≤‡∏¢‡∏∏‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤ 15 ‡∏õ‡∏µ ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏° ‡∏≠‡∏≤‡∏à‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πà‡∏≤‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏¥‡∏î‡∏≠‡∏≤‡∏ç‡∏≤")
            analysis.append("- ‡∏´‡∏≤‡∏Å‡∏ö‡∏£‡∏£‡∏•‡∏∏‡∏ô‡∏¥‡∏ï‡∏¥‡∏†‡∏≤‡∏ß‡∏∞‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏° ‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏¥‡∏î‡∏≠‡∏≤‡∏ç‡∏≤")
            advice.append("- ‡∏Ñ‡∏ß‡∏£‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° ‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡∏ó‡∏ô‡∏≤‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°")
            related_laws.extend(["‡∏°‡∏≤‡∏ï‡∏£‡∏≤ 276", "‡∏°‡∏≤‡∏ï‡∏£‡∏≤ 277"])
    # ‡∏Å‡∏£‡∏ì‡∏µ "‡∏ó‡∏≥‡πÄ‡∏î‡πá‡∏Å‡∏ó‡πâ‡∏≠‡∏á" ‡∏´‡∏£‡∏∑‡∏≠ "‡∏ä‡∏≥‡πÄ‡∏£‡∏≤‡πÄ‡∏î‡πá‡∏Å"
    elif is_pregnant and is_child:
        verdict = "‚ùå ‡∏ú‡∏¥‡∏î - ‡∏ê‡∏≤‡∏ô‡∏ä‡∏≥‡πÄ‡∏£‡∏≤‡πÄ‡∏î‡πá‡∏Å‡∏≠‡∏≤‡∏¢‡∏∏‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤ 15 ‡∏õ‡∏µ"
        analysis.append("- ‡∏Å‡∏≤‡∏£‡∏°‡∏µ‡πÄ‡∏û‡∏®‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏Å‡∏±‡∏ö‡πÄ‡∏î‡πá‡∏Å‡∏≠‡∏≤‡∏¢‡∏∏‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤ 15 ‡∏õ‡∏µ ‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏°‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢")
        analysis.append("- ‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢‡∏≠‡∏≤‡∏ç‡∏≤ ‡∏°‡∏≤‡∏ï‡∏£‡∏≤ 277")
        advice.append("- ‡πÅ‡∏à‡πâ‡∏á‡∏ú‡∏π‡πâ‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡πÅ‡∏à‡πâ‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏±‡∏ö‡∏ï‡∏≥‡∏£‡∏ß‡∏à")
        advice.append("- ‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏°‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏û‡∏¢‡∏≤‡∏ô")
        related_laws.append("‡∏°‡∏≤‡∏ï‡∏£‡∏≤ 277")
    # ‡∏Å‡∏£‡∏ì‡∏µ "‡∏Ç‡πà‡∏°‡∏Ç‡∏∑‡∏ô"
    elif is_rape:
        verdict = "‚ùå ‡∏ú‡∏¥‡∏î - ‡∏ê‡∏≤‡∏ô‡∏Ç‡πà‡∏°‡∏Ç‡∏∑‡∏ô‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ä‡∏≥‡πÄ‡∏£‡∏≤"
        analysis.append("- ‡∏Å‡∏≤‡∏£‡∏°‡∏µ‡πÄ‡∏û‡∏®‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏°‡∏Ç‡∏≠‡∏á‡∏ù‡πà‡∏≤‡∏¢‡∏´‡∏ç‡∏¥‡∏á ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏¥‡∏î‡∏ê‡∏≤‡∏ô‡∏Ç‡πà‡∏°‡∏Ç‡∏∑‡∏ô")
        analysis.append("- ‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢‡∏≠‡∏≤‡∏ç‡∏≤ ‡∏°‡∏≤‡∏ï‡∏£‡∏≤ 276")
        advice.append("- ‡πÅ‡∏à‡πâ‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏±‡∏ö‡∏ï‡∏≥‡∏£‡∏ß‡∏à‡∏ó‡∏±‡∏ô‡∏ó‡∏µ")
        advice.append("- ‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏°‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏û‡∏¢‡∏≤‡∏ô")
        related_laws.append("‡∏°‡∏≤‡∏ï‡∏£‡∏≤ 276")
    # ‡∏Å‡∏£‡∏ì‡∏µ "‡∏°‡∏µ‡πÄ‡∏û‡∏®‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏Å‡∏±‡∏ö‡πÄ‡∏î‡πá‡∏Å/‡∏ú‡∏π‡πâ‡πÄ‡∏¢‡∏≤‡∏ß‡πå"
    elif is_child:
        verdict = "‚ùå ‡∏ú‡∏¥‡∏î - ‡∏ê‡∏≤‡∏ô‡∏ä‡∏≥‡πÄ‡∏£‡∏≤‡πÄ‡∏î‡πá‡∏Å‡∏≠‡∏≤‡∏¢‡∏∏‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤ 15 ‡∏õ‡∏µ"
        analysis.append("- ‡∏Å‡∏≤‡∏£‡∏°‡∏µ‡πÄ‡∏û‡∏®‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏Å‡∏±‡∏ö‡πÄ‡∏î‡πá‡∏Å‡∏≠‡∏≤‡∏¢‡∏∏‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤ 15 ‡∏õ‡∏µ ‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏°‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢")
        analysis.append("- ‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢‡∏≠‡∏≤‡∏ç‡∏≤ ‡∏°‡∏≤‡∏ï‡∏£‡∏≤ 277")
        advice.append("- ‡πÅ‡∏à‡πâ‡∏á‡∏ú‡∏π‡πâ‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡πÅ‡∏à‡πâ‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏±‡∏ö‡∏ï‡∏≥‡∏£‡∏ß‡∏à")
        advice.append("- ‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏°‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏û‡∏¢‡∏≤‡∏ô")
        related_laws.append("‡∏°‡∏≤‡∏ï‡∏£‡∏≤ 277")
    else:
        verdict = "‚ö†Ô∏è ‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡πÄ‡∏ó‡πá‡∏à‡∏à‡∏£‡∏¥‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°"
        analysis.append("- ‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡πÄ‡∏ó‡πá‡∏à‡∏à‡∏£‡∏¥‡∏á‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏≠‡∏≤‡∏¢‡∏∏‡∏Ç‡∏≠‡∏á‡∏ù‡πà‡∏≤‡∏¢‡∏´‡∏ç‡∏¥‡∏á‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏°")
        analysis.append("- ‡∏´‡∏≤‡∏Å‡∏ù‡πà‡∏≤‡∏¢‡∏´‡∏ç‡∏¥‡∏á‡∏≠‡∏≤‡∏¢‡∏∏‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤ 15 ‡∏õ‡∏µ ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏° ‡∏≠‡∏≤‡∏à‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πà‡∏≤‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏¥‡∏î‡∏≠‡∏≤‡∏ç‡∏≤")
        analysis.append("- ‡∏´‡∏≤‡∏Å‡∏ö‡∏£‡∏£‡∏•‡∏∏‡∏ô‡∏¥‡∏ï‡∏¥‡∏†‡∏≤‡∏ß‡∏∞‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏° ‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏¥‡∏î‡∏≠‡∏≤‡∏ç‡∏≤")
        advice.append("- ‡∏Ñ‡∏ß‡∏£‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° ‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡∏ó‡∏ô‡∏≤‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°")
        related_laws.extend(["‡∏°‡∏≤‡∏ï‡∏£‡∏≤ 276", "‡∏°‡∏≤‡∏ï‡∏£‡∏≤ 277"])

    # ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡πÄ‡∏™‡∏°‡∏≠
    if related_laws:
        analysis.append("\n‡∏Ç‡πâ‡∏≠‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á: " + ', '.join(related_laws))

    return verdict, '\n'.join(analysis), '\n'.join(advice)

def create_answer(results: List[dict], question: str) -> str:
    """‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏à‡∏≤‡∏Å‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ (template ‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô)"""
    if not results:
        return "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á"

    q = question.lower()
    main_law = results[0]
    # ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å main_law ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î
    if any(word in q for word in ['‡∏û‡∏£‡∏≤‡∏Å']):
        for law in results:
            if '‡∏û‡∏£‡∏≤‡∏Å' in law.get('title', '') or '‡∏û‡∏£‡∏≤‡∏Å' in law.get('text', ''):
                main_law = law
                break
    elif any(word in q for word in ['‡∏Ç‡πÇ‡∏°‡∏¢', '‡∏•‡∏±‡∏Å', '‡∏•‡∏±‡∏Å‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå']):
        for law in results:
            if any(w in law.get('title', '') for w in ['‡∏•‡∏±‡∏Å‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå', '‡∏Ç‡πÇ‡∏°‡∏¢']) or any(w in law.get('text', '') for w in ['‡∏•‡∏±‡∏Å‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå', '‡∏Ç‡πÇ‡∏°‡∏¢']):
                main_law = law
                break
    elif any(word in q for word in ['‡∏ó‡∏≥‡∏£‡πâ‡∏≤‡∏¢', '‡∏ï‡∏ö', '‡∏ï‡∏µ']):
        for law in results:
            if '‡∏ó‡∏≥‡∏£‡πâ‡∏≤‡∏¢' in law.get('title', '') or '‡∏ó‡∏≥‡∏£‡πâ‡∏≤‡∏¢' in law.get('text', ''):
                main_law = law
                break
    elif any(word in q for word in ['‡∏ó‡πâ‡∏≠‡∏á', '‡∏ó‡∏≥‡∏ó‡πâ‡∏≠‡∏á', '‡∏ä‡∏≥‡πÄ‡∏£‡∏≤', '‡∏Ç‡πà‡∏°‡∏Ç‡∏∑‡∏ô']):
        for law in results:
            if '277' in law.get('title', '') or '277' in law.get('code', '') or '‡∏ä‡∏≥‡πÄ‡∏£‡∏≤' in law.get('title', '') or '‡∏ä‡∏≥‡πÄ‡∏£‡∏≤' in law.get('text', ''):
                main_law = law
                break

    # ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡πÄ‡∏ó‡πá‡∏à‡∏à‡∏£‡∏¥‡∏á‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥
    verdict, analysis, advice = analyze_case(question, main_law)

    law_text = main_law.get('text', '')

    answer = f"""
## üéØ **‡∏Ñ‡∏≥‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô**
{verdict}

## üìã **‡∏Ç‡πâ‡∏≠‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á**
**{main_law.get('title', '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢')}**
{law_text}

## üîé **‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡πÄ‡∏ó‡πá‡∏à‡∏à‡∏£‡∏¥‡∏á**
{analysis}

## üí° **‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏ä‡∏¥‡∏á‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥**
{advice}

## **‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç**
‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏Ñ‡∏≥‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡∏ó‡∏≤‡∏á‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á
"""

    if len(results) > 1:
        answer += "\n## üìö **‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°**\n"
        for i, law in enumerate(results[1:3], 1):
            clean_text = law.get('text', '')
            answer += f"**{i}. {law.get('title', '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢')}**\n{clean_text}\n\n"

    return answer.strip()

def calculate_confidence(results: List[dict], question: str) -> float:
    """‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏±‡πà‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö"""
    if not results:
        return 0.0
    
    # ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≤‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á
    max_score = max(result["relevance_score"] for result in results)
    total_words = len(pythainlp.word_tokenize(question, keep_whitespace=False))
    
    if total_words == 0:
        return 0.0
    
    confidence = min(max_score / total_words, 1.0)
    return round(confidence, 2)

@app.exception_handler(Exception)
async def global_exception_handler(request: Request, exc: Exception):
    """‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ"""
    logger.error(f"‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏Ñ‡∏≤‡∏î‡∏Ñ‡∏¥‡∏î: {exc}")
    return JSONResponse(
        status_code=500,
        content={"detail": "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á"}
    )

if __name__ == "__main__":
    import uvicorn
    uvicorn.run(app, host="127.0.0.1", port=8003) 